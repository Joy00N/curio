<ion-header>
  <ion-toolbar>
    <ion-title>History</ion-title>
  </ion-toolbar>
  <ion-toolbar *ngIf="!isLoading && allEntries.length > 0">
    <ion-searchbar
      [(ngModel)]="searchQuery"
      (ionInput)="onSearchChange($event)"
      placeholder="Search topics..."
      [debounce]="300"
      animated
    ></ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="state-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading history...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="state-container">
    <ion-icon name="alert-circle-outline" color="danger" size="large"></ion-icon>
    <ion-text color="danger">
      <p>{{ errorMessage }}</p>
    </ion-text>
    <ion-button expand="block" fill="outline" (click)="retry()">
      Retry
    </ion-button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && allEntries.length === 0" class="state-container">
    <ion-icon name="book-outline" color="medium" size="large"></ion-icon>
    <h2>No Topics Yet</h2>
    <p>Topics you learn will appear here</p>
    <ion-button routerLink="/tabs/home" expand="block">
      Explore Topics
    </ion-button>
  </div>

  <!-- No Search Results -->
  <div *ngIf="!isLoading && searchQuery && filteredEntries.length === 0" class="state-container">
    <ion-icon name="search-outline" color="medium" size="large"></ion-icon>
    <h2>No Results</h2>
    <p>No topics match "{{ searchQuery }}"</p>
    <ion-button expand="block" fill="clear" (click)="clearSearch()">
      Clear Search
    </ion-button>
  </div>

  <!-- History List -->
  <ion-list *ngIf="!isLoading && filteredEntries.length > 0" lines="none">
    <ion-item
      *ngFor="let entry of filteredEntries; trackBy: trackByEntryId"
      button
      (click)="openEntry(entry)"
      detail="false"
      class="history-item"
    >
      <div class="item-content">
        <div class="item-header">
          <div class="category-badge" *ngIf="entry.category">
            {{ entry.category }}
          </div>
          <ion-icon
            *ngIf="entry.isFavorite"
            name="heart"
            color="danger"
            class="favorite-icon"
          ></ion-icon>
        </div>
        <h3 class="topic-title">{{ entry.topic }}</h3>
        <p class="teaser">{{ entry.teaser }}</p>
        <div class="meta">
          <span class="date">{{ formatDate(entry.date) }}</span>
          <span class="source-badge" [class.user-query]="entry.source === 'userQuery'">
            {{ entry.source === 'userQuery' ? 'Custom' : 'Daily' }}
          </span>
        </div>
      </div>
      <ion-icon slot="end" name="chevron-forward-outline" color="medium"></ion-icon>
    </ion-item>
  </ion-list>
</ion-content>
